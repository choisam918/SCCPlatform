<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SCC Platform">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#667eea">
  <title>SCC Platform</title>
  <!-- å„ªåŒ–å­—é«”è¼‰å…¥ -->
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap"></noscript>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <div class="hero-banner">
    <h1>SCC Platform</h1>
    <!-- æè¿°æ–‡å­— - å·²éš±è— -->
    <p class="hero-desc" style="display: none;">å¤šå…ƒå­¸ç¿’å­ç³»çµ±æ•´åˆå¹³å°</p>
    <!-- ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• -->
    <div class="theme-toggle">
      <button class="theme-btn" id="themeToggleBtn" onclick="toggleTheme()">
        <span id="themeIcon">â˜€ï¸</span>
        <span id="themeText">æ·ºè‰²</span>
      </button>
      <button class="btn-admin-small" onclick="openAdminPage()">
        <span class="admin-icon">âš™ï¸</span>
        <span class="admin-text">ç®¡ç†è€…ç™»å…¥</span>
      </button>
    </div>
  </div>
  <div class="container">
    <!-- ç®¡ç†è€…ç™»å…¥æŒ‰éˆ• -->
    <div style="display: none;">
      <button class="btn-admin" onclick="openAdminPage()">
        <span class="admin-icon">âš™ï¸</span>
        <span class="admin-text">ç®¡ç†è€…ç™»å…¥</span>
      </button>
    </div>
    
    <!-- æœç´¢æ¡† - å·²éš±è— -->
    <div class="search-container" style="display: none;">
      <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢å­ç³»çµ±..." autocomplete="off">
      <div class="search-icon">ğŸ”</div>
    </div>
    
    <!-- åˆ†é¡ç¯©é¸æŒ‰éˆ• - å·²éš±è— -->
    <div class="category-filters" style="display: none;">
      <button class="category-btn active" data-category="all">å…¨éƒ¨ç³»çµ±</button>
      <button class="category-btn" data-category="knowledge">çŸ¥è­˜åˆ†é¡</button>
      <button class="category-btn" data-category="tools">å·¥å…·æ‡‰ç”¨</button>
    </div>
    <!-- æ•¸æ“šç®¡ç†æŒ‰éˆ•å·²ç§»é™¤ï¼Œåƒ…ç®¡ç†è€…é é¢ä¿ç•™ -->
    
    <div class="subsystems" id="subsystems"></div>
    
    <!-- æ•¸æ“šç®¡ç†æŒ‰éˆ• - å·²éš±è— -->
    <div class="data-management" style="margin-top: 30px; text-align: center; display: none;">
      <button onclick="dataManager.backupToCloud()" class="data-btn">
        <span>â˜ï¸</span>
        <span>é›²ç«¯å‚™ä»½</span>
      </button>
      <button onclick="dataManager.restoreFromCloud()" class="data-btn">
        <span>ğŸ“¥</span>
        <span>æ¢å¾©æ•¸æ“š</span>
      </button>
      <button onclick="dataManager.exportData('json')" class="data-btn">
        <span>ğŸ“¤</span>
        <span>å°å‡ºJSON</span>
      </button>
      <button onclick="dataManager.exportData('csv')" class="data-btn">
        <span>ğŸ“Š</span>
        <span>å°å‡ºCSV</span>
      </button>
      <button onclick="testNotification()" class="data-btn">
        <span>ğŸ””</span>
        <span>æ¸¬è©¦é€šçŸ¥</span>
      </button>
    </div>
    
    <!-- ç®¡ç†åŠŸèƒ½æŒ‰éˆ• -->
    <!-- å·²ç§»é™¤ç®¡ç†åŠŸèƒ½æŒ‰éˆ•å€å¡Š -->
    
    <!-- ç®¡ç†ç™»å…¥æŒ‰éˆ• - å·²éš±è— -->
    <div style="display: none;">
      <a class="btn-admin" href="admin.html" target="_blank">
        <span class="admin-icon">âš™ï¸</span>
        <span class="admin-text">ç®¡ç†ç™»å…¥</span>
      </a>
    </div>
  </div>
  <!-- é è…³ - å·²éš±è— -->
  <footer class="footer" style="display: none;">
    <span>Â© 2024 CCS Edu Platform</span>
  </footer>
  <!-- å·²ç§»é™¤ç®¡ç†åŠŸèƒ½æ¨¡æ…‹æ¡†å€å¡Š -->
  <script>
    // å­ç³»çµ±é…ç½®ï¼ˆåŠ å…¥åˆ†é¡ï¼‰- å›ºå®šé †åº
    const defaultSubsystems = [
      { name: 'é›²å±•è¦½', url: './cloudpictureplatform/index.html', desc: '3Dè™›æ“¬å±•è¦½é¤¨', img: './cloudpictureplatform/1.png', category: 'tools', visible: true },
      { name: '7äººè¶³çƒæˆ°è¡“æ¿', url: './football/index.html', desc: '7äººè¶³çƒæˆ°è¡“èˆ‡ç®¡ç†ç³»çµ±<br><span style="color: #2196F3;">(é›»è…¦æˆ–å¹³æ¿ä½¿ç”¨)</span>', img: './football/football.png', category: 'knowledge', visible: true },
      { name: 'éš¨æ©Ÿå¡', url: './ramdomcard/index.html', desc: 'æ¯å¤©æŠ½å–3å¼µå¡ç‰‡', img: './ramdomcard/1.png', category: 'tools', visible: true },
      { name: 'æ‰“å­—ç·´ç¿’', url: './typeanything/index.html', desc: 'ä¸­è‹±æ–‡æ‰“å­—ç·´ç¿’', img: './typeanything/1.png', category: 'knowledge', visible: true },
      { name: 'å››å‰‡é‹ç®—æ•¸å­¸ç·´ç¿’', url: './math/index.html', desc: 'å››å‰‡é‹ç®—æ•¸å­¸ç·´ç¿’', img: './math/Lovepik_com-380042738-math-calculator-symbol-compute.png', category: 'knowledge', visible: true },
      { name: 'æŠ½ç±¤', url: './ramdom/index.html', desc: 'å­¸è™ŸæŠ½ç±¤ç³»çµ±', img: './ramdom/1.png', category: 'tools', visible: true },
      { name: 'åˆ†çµ„å·¥å…·', url: './group/group.html', desc: 'å°çµ„åˆ†é…èˆ‡ç®¡ç†å·¥å…·', img: './group/1.png', category: 'tools', visible: true },
      { name: 'è¨ˆåˆ†æ’å', url: './Rank/index.html', desc: 'è¨ˆåˆ†æ’åç³»çµ±', img: './Rank/1.png', category: 'tools', visible: true },
      { name: 'Learning Python', url: './learningpython/index.html', desc: 'Python å­¸ç¿’ç³»çµ±', img: './learningpython/1.png', category: 'knowledge', visible: false },
      { name: 'èª²å ‚è¨ˆåˆ†', url: './mark/index.html', desc: 'èª²å ‚è¨ˆåˆ†ç³»çµ±', img: './mark/1.png', category: 'tools', visible: true },
      { name: 'å¿«é–ƒ', url: './flashmeaning/index.html', desc: 'å¿«é€Ÿå­¸ç¿’è‹±æ–‡ç”Ÿå­—', img: './flashmeaning/1.jpg', category: 'knowledge', visible: true },
      { name: 'Python ç¨‹å¼å±•ç¤ºç³»çµ±', url: './programshowsystem/index.html', desc: 'ä¸Šå‚³ Python ç¨‹å¼ã€å±•ç¤ºä¸¦åœ¨ç€è¦½å™¨ä¸­åŸ·è¡Œèˆ‡æŸ¥çœ‹é‹è¡Œçµæœ', img: './programshowsystem/1.PNG', category: 'tools', visible: true }
    ];

    let isDarkMode = localStorage.getItem('darkMode') === 'true';

    // DOM å…ƒç´ ç·©å­˜ï¼ˆæ¸›å°‘é‡è¤‡æŸ¥è©¢ï¼Œåœ¨ DOMContentLoaded æ™‚åˆå§‹åŒ–ï¼‰
    const elements = {};
    function initElements() {
      elements.subsystems = document.getElementById('subsystems');
      elements.themeIcon = document.getElementById('themeIcon');
      elements.themeText = document.getElementById('themeText');
      elements.searchInput = document.getElementById('searchInput');
    }
    // ç¯€æµï¼šé™åˆ¶ resize ç­‰é«˜é »äº‹ä»¶åŸ·è¡Œæ¬¡æ•¸
    function throttle(fn, ms) {
      let last = 0, timer = null;
      return function(...args) {
        const now = Date.now();
        if (now - last >= ms) {
          last = now;
          fn.apply(this, args);
        } else if (!timer) {
          timer = setTimeout(() => { timer = null; last = Date.now(); fn.apply(this, args); }, ms - (now - last));
        }
      };
    }

    // ä¸»é¡Œç³»çµ±
    let currentTheme = localStorage.getItem('theme') || 'light';
    
    // ä¸»é¡Œåˆ‡æ›å‡½æ•¸
    function toggleTheme() {
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }
    
    // è¨­ç½®ä¸»é¡Œ
    function setTheme(theme) {
      currentTheme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      
      // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
      updateThemeButton(theme);
      
      // å…¼å®¹èˆŠçš„æ·±è‰²æ¨¡å¼
      isDarkMode = theme === 'dark';
      localStorage.setItem('darkMode', isDarkMode);
    }
    
    // æ›´æ–°ä¸»é¡ŒæŒ‰éˆ•é¡¯ç¤ºï¼ˆä½¿ç”¨ç·©å­˜å…ƒç´ ï¼‰
    function updateThemeButton(theme) {
      const themeIcon = elements.themeIcon || document.getElementById('themeIcon');
      const themeText = elements.themeText || document.getElementById('themeText');
      if (!themeIcon || !themeText) return;
      if (theme === 'dark') {
        themeIcon.textContent = 'ğŸŒ™';
        themeText.textContent = 'æ·±è‰²';
      } else {
        themeIcon.textContent = 'â˜€ï¸';
        themeText.textContent = 'æ·ºè‰²';
      }
    }
    
    // åˆå§‹åŒ–ä¸»é¡Œ
    function initTheme() {
      // é»˜èªä½¿ç”¨æ·ºè‰²æ¨¡å¼
      if (!localStorage.getItem('theme')) {
        currentTheme = 'light';
      }
      
      setTheme(currentTheme);
    }
    
    // å…¼å®¹èˆŠçš„æ·±è‰²æ¨¡å¼å‡½æ•¸
    function toggleDarkMode() {
      toggleTheme();
    }
    
    function initDarkMode() {
      initTheme();
    }

    // æ•¸æ“šé©—è­‰å‡½æ•¸
    function validateSubsystem(subsystem) {
      const required = ['name', 'url'];
      const missing = required.filter(field => !subsystem[field]);
      if (missing.length > 0) {
        throw new Error(`å­ç³»çµ±ç¼ºå°‘å¿…è¦æ¬„ä½: ${missing.join(', ')}`);
      }
      
      if (subsystem.name.length > 50) {
        throw new Error('å­ç³»çµ±åç¨±éé•·');
      }
      
      if (subsystem.url.length > 200) {
        throw new Error('å­ç³»çµ±ç¶²å€éé•·');
      }
      
      return true;
    }
    
    // è¼‰å…¥å­ç³»çµ±æ•¸æ“šï¼ˆé¦–é åªåšå…¼å®¹ï¼Œä¸å†åˆä½µï¼‰
    function loadSubsystemsData() {
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ä¿å­˜çš„æ•¸æ“š
      const savedData = localStorage.getItem('subsystems');
      if (!savedData) {
        // åªæœ‰åœ¨æ²’æœ‰ä¿å­˜æ•¸æ“šæ™‚æ‰ä½¿ç”¨é è¨­å€¼
        localStorage.setItem('subsystems', JSON.stringify(defaultSubsystems));
      } else {
        // å¦‚æœæœ‰ä¿å­˜çš„æ•¸æ“šï¼Œæª¢æŸ¥æ˜¯å¦åŒ…å« Learning Python å’Œéš¨æ©Ÿå¡ç³»çµ±
        try {
          const parsed = JSON.parse(savedData);
          if (Array.isArray(parsed)) {
            let needsUpdate = false;
            
            // æª¢æŸ¥ Learning Python ç³»çµ±ï¼ˆè¨­ç½®ç‚ºéš±è—ï¼‰
            const learningPythonIndex = parsed.findIndex(sys => sys.name === 'Learning Python');
            if (learningPythonIndex === -1) {
              // å¦‚æœæ²’æœ‰ Learning Python ç³»çµ±ï¼Œæ·»åŠ åˆ°æœ«å°¾ä¸¦è¨­ç½®ç‚ºéš±è—
              const learningPython = defaultSubsystems.find(sys => sys.name === 'Learning Python');
              if (learningPython) {
                learningPython.visible = false;
                parsed.push(learningPython);
                needsUpdate = true;
              }
            } else {
              // å¦‚æœå·²æœ‰ Learning Python ç³»çµ±ï¼Œç¢ºä¿è¨­ç½®ç‚ºéš±è—ä¸¦æ›´æ–°å…¶åœ–æ¨™
              parsed[learningPythonIndex].visible = false;
              const learningPython = defaultSubsystems.find(sys => sys.name === 'Learning Python');
              if (learningPython) {
                if (parsed[learningPythonIndex].img !== learningPython.img) {
                  parsed[learningPythonIndex].img = learningPython.img;
                  needsUpdate = true;
                }
                if (parsed[learningPythonIndex].visible !== false) {
                  needsUpdate = true;
                }
              }
            }
            
            // åˆªé™¤èˆŠçš„"æ¯æ—¥å‹µå¿—å¡ç‰‡"ç³»çµ±ï¼ˆé¿å…é‡è¤‡ï¼‰
            const oldCardIndex = parsed.findIndex(sys => sys.name === 'æ¯æ—¥å‹µå¿—å¡ç‰‡');
            if (oldCardIndex !== -1) {
              parsed.splice(oldCardIndex, 1);
              needsUpdate = true;
            }
            
            // æª¢æŸ¥é›²å±•è¦½ç³»çµ±ï¼ˆç¢ºä¿åœ¨ç¬¬ä¸€ä½ï¼‰
            const cloudExhibitionIndex = parsed.findIndex(sys => sys.name === 'é›²å±•è¦½');
            if (cloudExhibitionIndex === -1) {
              // å¦‚æœæ²’æœ‰é›²å±•è¦½ç³»çµ±ï¼Œæ·»åŠ åˆ°ç¬¬ä¸€ä½
              const cloudExhibition = defaultSubsystems.find(sys => sys.name === 'é›²å±•è¦½');
              if (cloudExhibition) {
                parsed.unshift(cloudExhibition); // ä½¿ç”¨ unshift æ·»åŠ åˆ°ç¬¬ä¸€ä½
                needsUpdate = true;
              }
            } else if (cloudExhibitionIndex !== 0) {
              // å¦‚æœé›²å±•è¦½ç³»çµ±ä¸åœ¨ç¬¬ä¸€ä½ï¼Œç§»åˆ°ç¬¬ä¸€ä½
              const cloudExhibition = parsed.splice(cloudExhibitionIndex, 1)[0];
              parsed.unshift(cloudExhibition);
              needsUpdate = true;
            } else {
              // å¦‚æœå·²åœ¨ç¬¬ä¸€ä½ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æè¿°å’Œåœ–æ¨™
              const cloudExhibition = defaultSubsystems.find(sys => sys.name === 'é›²å±•è¦½');
              if (cloudExhibition) {
                if (parsed[0].desc !== cloudExhibition.desc || parsed[0].img !== cloudExhibition.img || parsed[0].url !== cloudExhibition.url) {
                  parsed[0].desc = cloudExhibition.desc;
                  parsed[0].img = cloudExhibition.img;
                  parsed[0].url = cloudExhibition.url;
                  needsUpdate = true;
                }
              }
            }
            
            // æª¢æŸ¥è¶³çƒç³»çµ±ï¼ˆç¢ºä¿åœ¨ç¬¬äºŒä½ï¼Œå¦‚æœé›²å±•è¦½å­˜åœ¨ï¼‰
            const footballIndex = parsed.findIndex(sys => sys.name === '7äººè¶³çƒæˆ°è¡“æ¿');
            const cloudExhibitionExists = parsed.findIndex(sys => sys.name === 'é›²å±•è¦½') === 0;
            const footballTargetPosition = cloudExhibitionExists ? 1 : 0; // å¦‚æœé›²å±•è¦½å­˜åœ¨ï¼Œç›®æ¨™ä½ç½®æ˜¯1ï¼Œå¦å‰‡ç‚º0
            
            if (footballIndex === -1) {
              // å¦‚æœæ²’æœ‰è¶³çƒç³»çµ±ï¼Œæ·»åŠ åˆ°ç›®æ¨™ä½ç½®
              const footballSystem = defaultSubsystems.find(sys => sys.name === '7äººè¶³çƒæˆ°è¡“æ¿');
              if (footballSystem) {
                parsed.splice(footballTargetPosition, 0, footballSystem);
                needsUpdate = true;
              }
            } else if (footballIndex !== footballTargetPosition) {
              // å¦‚æœè¶³çƒç³»çµ±ä¸åœ¨ç›®æ¨™ä½ç½®ï¼Œç§»åˆ°ç›®æ¨™ä½ç½®
              const footballSystem = parsed.splice(footballIndex, 1)[0];
              parsed.splice(footballTargetPosition, 0, footballSystem);
              needsUpdate = true;
            } else {
              // å¦‚æœå·²åœ¨ç›®æ¨™ä½ç½®ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æè¿°å’Œåœ–æ¨™
              const footballSystem = defaultSubsystems.find(sys => sys.name === '7äººè¶³çƒæˆ°è¡“æ¿');
              if (footballSystem) {
                if (parsed[footballTargetPosition].desc !== footballSystem.desc || parsed[footballTargetPosition].img !== footballSystem.img || parsed[footballTargetPosition].url !== footballSystem.url) {
                  parsed[footballTargetPosition].desc = footballSystem.desc;
                  parsed[footballTargetPosition].img = footballSystem.img;
                  parsed[footballTargetPosition].url = footballSystem.url;
                  needsUpdate = true;
                }
              }
            }
            
            // æª¢æŸ¥å¿«é–ƒç³»çµ±ï¼ˆç¢ºä¿åœ¨æœ€å¾Œä¸€å€‹ä½ç½®ä¸¦é¡¯ç¤ºï¼‰
            const flashIndex = parsed.findIndex(sys => sys.name === 'å¿«é–ƒ' || sys.name === 'æ€é–ƒ');
            
            if (flashIndex === -1) {
              // å¦‚æœæ²’æœ‰å¿«é–ƒç³»çµ±ï¼Œæ·»åŠ åˆ°æœ€å¾Œ
              const flashSystem = defaultSubsystems.find(sys => sys.name === 'å¿«é–ƒ');
              if (flashSystem) {
                flashSystem.visible = true; // è¨­ç½®ç‚ºé¡¯ç¤º
                parsed.push(flashSystem); // æ·»åŠ åˆ°æ•¸çµ„æœ«å°¾
                needsUpdate = true;
              }
            } else {
              // å¦‚æœå·²æœ‰å¿«é–ƒç³»çµ±ï¼Œç¢ºä¿åœ¨æœ€å¾Œä¸¦é¡¯ç¤º
              // çµ±ä¸€åç¨±ç‚º"å¿«é–ƒ"
              if (parsed[flashIndex].name === 'æ€é–ƒ') {
                parsed[flashIndex].name = 'å¿«é–ƒ';
                needsUpdate = true;
              }
              
              // ç¢ºä¿è¨­ç½®ç‚ºé¡¯ç¤º
              if (parsed[flashIndex].visible !== true) {
                parsed[flashIndex].visible = true;
                needsUpdate = true;
              }
              
              // å¦‚æœä¸åœ¨æœ€å¾Œä½ç½®ï¼Œç§»åˆ°æœ€å¾Œ
              const lastIndex = parsed.length - 1;
              if (flashIndex !== lastIndex) {
                const flashSystem = parsed.splice(flashIndex, 1)[0];
                parsed.push(flashSystem); // æ·»åŠ åˆ°æœ€å¾Œ
                needsUpdate = true;
              }
              
              // æ›´æ–°æè¿°å’Œåœ–æ¨™ï¼ˆç¾åœ¨åœ¨æœ€å¾Œä½ç½®ï¼‰
              const flashSystem = defaultSubsystems.find(sys => sys.name === 'å¿«é–ƒ');
              if (flashSystem) {
                const currentFlashIndex = parsed.length - 1; // æœ€å¾Œä¸€å€‹ä½ç½®
                if (parsed[currentFlashIndex].desc !== flashSystem.desc || parsed[currentFlashIndex].img !== flashSystem.img) {
                  parsed[currentFlashIndex].desc = flashSystem.desc;
                  parsed[currentFlashIndex].img = flashSystem.img;
                  needsUpdate = true;
                }
              }
            }
            
            // æª¢æŸ¥èª²å ‚è¨ˆåˆ†ç³»çµ±
            const markIndex = parsed.findIndex(sys => sys.name === 'èª²å ‚è¨ˆåˆ†');
            if (markIndex === -1) {
              // å¦‚æœæ²’æœ‰èª²å ‚è¨ˆåˆ†ç³»çµ±ï¼Œæ·»åŠ åˆ°æœ«å°¾
              const markSystem = defaultSubsystems.find(sys => sys.name === 'èª²å ‚è¨ˆåˆ†');
              if (markSystem) {
                parsed.push(markSystem);
                needsUpdate = true;
              }
            } else {
              // å¦‚æœå·²æœ‰èª²å ‚è¨ˆåˆ†ç³»çµ±ï¼Œæ›´æ–°å…¶æè¿°å’Œåœ–æ¨™
              const markSystem = defaultSubsystems.find(sys => sys.name === 'èª²å ‚è¨ˆåˆ†');
              if (markSystem) {
                if (parsed[markIndex].desc !== markSystem.desc || parsed[markIndex].img !== markSystem.img) {
                  parsed[markIndex].desc = markSystem.desc;
                  parsed[markIndex].img = markSystem.img;
                  needsUpdate = true;
                }
              }
            }
            
            // æª¢æŸ¥ Python ç¨‹å¼å±•ç¤ºç³»çµ±ï¼ˆç¬¬12å€‹å¡ç‰‡ï¼‰
            const programShowIndex = parsed.findIndex(sys => sys.name === 'Python ç¨‹å¼å±•ç¤ºç³»çµ±');
            if (programShowIndex === -1) {
              const programShowSystem = defaultSubsystems.find(sys => sys.name === 'Python ç¨‹å¼å±•ç¤ºç³»çµ±');
              if (programShowSystem) {
                parsed.push(programShowSystem);
                needsUpdate = true;
              }
            } else {
              const programShowSystem = defaultSubsystems.find(sys => sys.name === 'Python ç¨‹å¼å±•ç¤ºç³»çµ±');
              if (programShowSystem && (parsed[programShowIndex].desc !== programShowSystem.desc || parsed[programShowIndex].img !== programShowSystem.img || parsed[programShowIndex].url !== programShowSystem.url)) {
                parsed[programShowIndex].desc = programShowSystem.desc;
                parsed[programShowIndex].img = programShowSystem.img;
                parsed[programShowIndex].url = programShowSystem.url;
                needsUpdate = true;
              }
            }
            
            if (needsUpdate) {
              localStorage.setItem('subsystems', JSON.stringify(parsed));
            }
          }
        } catch (e) {
          // å¦‚æœè§£æå¤±æ•—ï¼Œä½¿ç”¨é»˜èªå€¼
          localStorage.setItem('subsystems', JSON.stringify(defaultSubsystems));
        }
      }
    }

    // ä¿å­˜å­ç³»çµ±æ•¸æ“š
    function saveSubsystemsData() {
      const subsystems = getSubsystemsForIndex();
      localStorage.setItem('subsystems', JSON.stringify(subsystems));
    }
    
    // æ•¸æ“šç®¡ç†å¢å¼·åŠŸèƒ½
    class DataManager {
      constructor() {
        this.version = '2.0.0';
        this.lastBackup = localStorage.getItem('lastBackup') || null;
      }
      
      // å‚™ä»½æ•¸æ“šåˆ°é›²ç«¯
      async backupToCloud() {
        try {
          const data = {
            subsystems: getSubsystemsForIndex(),
            settings: {
              darkMode: isDarkMode,
              category: 'all',
              lastVisit: new Date().toISOString()
            },
            stats: JSON.parse(localStorage.getItem('usageStats') || '{}'),
            version: this.version,
            timestamp: new Date().toISOString()
          };
          
          // æ¨¡æ“¬é›²ç«¯å‚™ä»½ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æœƒç™¼é€åˆ°çœŸå¯¦APIï¼‰
          console.log('å‚™ä»½æ•¸æ“šåˆ°é›²ç«¯:', data);
          
          // ä¿å­˜å‚™ä»½æ™‚é–“
          this.lastBackup = new Date().toISOString();
          localStorage.setItem('lastBackup', this.lastBackup);
          
          this.showNotification('å‚™ä»½æˆåŠŸ', 'success');
          return true;
        } catch (error) {
          console.error('å‚™ä»½å¤±æ•—:', error);
          this.showNotification('å‚™ä»½å¤±æ•—', 'error');
          return false;
        }
      }
      
      // å¾é›²ç«¯æ¢å¾©æ•¸æ“š
      async restoreFromCloud() {
        try {
          // æ¨¡æ“¬å¾é›²ç«¯æ¢å¾©æ•¸æ“š
          console.log('å¾é›²ç«¯æ¢å¾©æ•¸æ“š');
          
          // é€™è£¡æœƒå¾çœŸå¯¦APIç²å–æ•¸æ“š
          const currentSystems = getSubsystemsForIndex();
          const restoredData = {
            subsystems: currentSystems,
            settings: { darkMode: false, category: 'all' }
          };
          
          // æ‡‰ç”¨æ¢å¾©çš„æ•¸æ“š
          if (restoredData.subsystems && Array.isArray(restoredData.subsystems)) {
            localStorage.setItem('subsystems', JSON.stringify(restoredData.subsystems));
          }
          if (restoredData.settings) {
            isDarkMode = restoredData.settings.darkMode;
            if (restoredData.settings.darkMode !== undefined) {
              setTheme(restoredData.settings.darkMode ? 'dark' : 'light');
            }
          }
          
          saveSubsystemsData();
          renderSubsystems();
          initDarkMode();
          
          this.showNotification('æ¢å¾©æˆåŠŸ', 'success');
          return true;
        } catch (error) {
          console.error('æ¢å¾©å¤±æ•—:', error);
          this.showNotification('æ¢å¾©å¤±æ•—', 'error');
          return false;
        }
      }
      
      // å°å‡ºæ•¸æ“š
      exportData(format = 'json') {
        const data = {
          subsystems: getSubsystemsForIndex(),
          settings: {
            darkMode: isDarkMode,
            category: 'all'
          },
          stats: JSON.parse(localStorage.getItem('usageStats') || '{}'),
          exportDate: new Date().toISOString(),
          version: this.version
        };
        
        let content, filename, mimeType;
        
        switch (format) {
          case 'json':
            content = JSON.stringify(data, null, 2);
            filename = `ccs-platform-backup-${new Date().toISOString().split('T')[0]}.json`;
            mimeType = 'application/json';
            break;
          case 'csv':
            content = this.convertToCSV(data.subsystems);
            filename = `ccs-platform-subsystems-${new Date().toISOString().split('T')[0]}.csv`;
            mimeType = 'text/csv';
            break;
          case 'xml':
            content = this.convertToXML(data);
            filename = `ccs-platform-backup-${new Date().toISOString().split('T')[0]}.xml`;
            mimeType = 'application/xml';
            break;
          case 'yaml':
            content = this.convertToYAML(data);
            filename = `ccs-platform-backup-${new Date().toISOString().split('T')[0]}.yaml`;
            mimeType = 'text/yaml';
            break;
          default:
            throw new Error('ä¸æ”¯æ´çš„æ ¼å¼');
        }
        
        this.downloadFile(content, filename, mimeType);
        this.showNotification(`å·²å°å‡º ${format.toUpperCase()} æ ¼å¼`, 'success');
      }
      
      // è½‰æ›ç‚ºCSVæ ¼å¼
      convertToCSV(subsystems) {
        const headers = ['name', 'url', 'desc', 'img', 'category', 'visible'];
        const csvContent = [
          headers.join(','),
          ...subsystems.map(sys => 
            headers.map(header => {
              const value = sys[header] || '';
              return `"${value.toString().replace(/"/g, '""')}"`;
            }).join(',')
          )
        ].join('\n');
        
        return csvContent;
      }
      
      // è½‰æ›ç‚ºXMLæ ¼å¼
      convertToXML(data) {
        const xml = `<?xml version="1.0" encoding="UTF-8"?>
<ccs-platform>
  <version>${data.version}</version>
  <export-date>${data.exportDate}</export-date>
  <settings>
    <dark-mode>${data.settings.darkMode}</dark-mode>
    <category>${data.settings.category}</category>
  </settings>
  <subsystems>
    ${data.subsystems.map(sys => `
    <subsystem>
      <name>${escapeXml(sys.name)}</name>
      <url>${escapeXml(sys.url)}</url>
      <desc>${escapeXml(sys.desc || '')}</desc>
      <img>${escapeXml(sys.img || '')}</img>
      <category>${escapeXml(sys.category)}</category>
      <visible>${sys.visible}</visible>
    </subsystem>`).join('')}
  </subsystems>
</ccs-platform>`;
        
        return xml;
      }
      
      // è½‰æ›ç‚ºYAMLæ ¼å¼
      convertToYAML(data) {
        const yaml = `version: ${data.version}
export_date: ${data.exportDate}
settings:
  dark_mode: ${data.settings.darkMode}
  category: ${data.settings.category}
subsystems:
${data.subsystems.map(sys => `  - name: ${sys.name}
    url: ${sys.url}
    desc: ${sys.desc || ''}
    img: ${sys.img || ''}
    category: ${sys.category}
    visible: ${sys.visible}`).join('\n')}`;
        
        return yaml;
      }
      
      // ä¸‹è¼‰æ–‡ä»¶
      downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      
      // é¡¯ç¤ºé€šçŸ¥
      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }
      
      // ç³»çµ±å¥åº·æª¢æŸ¥
      async systemHealthCheck() {
        const systems = getSubsystemsForIndex();
        const health = {
          totalSystems: systems.length,
          activeSystems: systems.filter(s => s.visible !== false).length,
          brokenLinks: [],
          performance: {},
          lastBackup: this.lastBackup,
          storageUsage: this.getStorageUsage()
        };
        
        // æª¢æŸ¥é€£çµæœ‰æ•ˆæ€§
        for (const sys of systems) {
          try {
            const response = await fetch(sys.url, { method: 'HEAD' });
            if (!response.ok) {
              health.brokenLinks.push(sys.name);
            }
          } catch (error) {
            health.brokenLinks.push(sys.name);
          }
        }
        
        return health;
      }
      
      // ç²å–å­˜å„²ä½¿ç”¨æƒ…æ³
      getStorageUsage() {
        const used = new Blob([localStorage.getItem('subsystems') || '']).size;
        const total = 5 * 1024 * 1024; // 5MB é™åˆ¶
        return {
          used: used,
          total: total,
          percentage: (used / total * 100).toFixed(2)
        };
      }
    }
    
    // å‰µå»ºæ•¸æ“šç®¡ç†å™¨å¯¦ä¾‹
    const dataManager = new DataManager();
    
    // æ¨é€é€šçŸ¥åŠŸèƒ½
    async function requestNotificationPermission() {
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          console.log('æ¨é€é€šçŸ¥æ¬Šé™å·²æˆäºˆ');
          subscribeToPushNotifications();
        } else {
          console.log('æ¨é€é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•');
        }
      } catch (error) {
        console.error('è«‹æ±‚æ¨é€é€šçŸ¥æ¬Šé™å¤±æ•—:', error);
      }
    }
    
    
    // æ¸¬è©¦æ¨é€é€šçŸ¥
    function testNotification() {
      // ä½¿ç”¨ç€è¦½å™¨åŸç”Ÿé€šçŸ¥
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('SCC Platform', {
          body: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦é€šçŸ¥',
          vibrate: [100, 50, 100],
          data: {
            dateOfArrival: Date.now(),
            primaryKey: 1
          }
        });
      } else if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            new Notification('SCC Platform', {
              body: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦é€šçŸ¥',
              vibrate: [100, 50, 100],
              data: {
                dateOfArrival: Date.now(),
                primaryKey: 1
              }
            });
          } else {
            alert('é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•');
          }
        });
      } else {
        alert('é€šçŸ¥åŠŸèƒ½ä¸å¯ç”¨');
      }
    }





    // æ‹–æ‹½æ’åºåŠŸèƒ½
    let isDragMode = false;
    let draggedElement = null;

    function toggleDragMode() {
      isDragMode = !isDragMode;
      const cards = document.querySelectorAll('.card');
      
      cards.forEach(card => {
        if (isDragMode) {
          card.draggable = true;
          card.style.cursor = 'grab';
          card.addEventListener('dragstart', handleDragStart);
          card.addEventListener('dragover', handleDragOver);
          card.addEventListener('drop', handleDrop);
          card.addEventListener('dragend', handleDragEnd);
        } else {
          card.draggable = false;
          card.style.cursor = 'pointer';
          card.classList.remove('dragging', 'drag-over');
          card.removeEventListener('dragstart', handleDragStart);
          card.removeEventListener('dragover', handleDragOver);
          card.removeEventListener('drop', handleDrop);
          card.removeEventListener('dragend', handleDragEnd);
        }
      });
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      const btn = document.querySelector('[onclick="toggleDragMode()"]');
      if (isDragMode) {
        btn.innerHTML = '<span class="admin-func-icon">âœ…</span><span class="admin-func-text">å®Œæˆæ’åº</span>';
        btn.style.background = 'linear-gradient(90deg, #10b981 60%, #059669 100%)';
      } else {
        btn.innerHTML = '<span class="admin-func-icon">ğŸ“‹</span><span class="admin-func-text">æ’åºç®¡ç†</span>';
        btn.style.background = 'linear-gradient(90deg, #6366f1 60%, #8b5cf6 100%)';
      }
    }

    function handleDragStart(e) {
      draggedElement = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      if (e.target.classList.contains('card') && e.target !== draggedElement) {
        e.target.classList.add('drag-over');
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      if (e.target.classList.contains('card') && e.target !== draggedElement) {
        const draggedIndex = Array.from(draggedElement.parentNode.children).indexOf(draggedElement);
        const dropIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
        
        // é‡æ–°æ’åºå­ç³»çµ±æ•¸çµ„
        const systems = getSubsystemsForIndex();
        const draggedSystem = systems.splice(draggedIndex, 1)[0];
        systems.splice(dropIndex, 0, draggedSystem);
        
        // ä¿å­˜æ–°é †åº
        localStorage.setItem('subsystems', JSON.stringify(systems));
        
        // é‡æ–°æ¸²æŸ“
        renderSubsystems();
      }
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.card').forEach(card => {
        card.classList.remove('drag-over');
      });
    }

    // è‡ªå®šç¾©åœ–æ¨™åŠŸèƒ½
    function showCustomizeModal() {
      const modal = document.getElementById('customizeModal');
      const systemSelect = document.getElementById('systemSelect');
      
      if (!modal || !systemSelect) return;
      
      // å¡«å……å­ç³»çµ±é¸é …
      systemSelect.innerHTML = '<option value="">è«‹é¸æ“‡å­ç³»çµ±</option>';
      const systems = getSubsystemsForIndex();
      systems.forEach(sys => {
        const option = document.createElement('option');
        option.value = sys.name;
        option.textContent = sys.name;
        systemSelect.appendChild(option);
      });
      
      modal.classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function saveCustomIcon() {
      const systemName = document.getElementById('systemSelect').value;
      const iconPath = document.getElementById('iconPath').value;
      
      if (!systemName || !iconPath) {
        alert('è«‹é¸æ“‡å­ç³»çµ±ä¸¦è¼¸å…¥åœ–æ¨™è·¯å¾‘');
        return;
      }
      
      const systems = getSubsystemsForIndex();
      const system = systems.find(sys => sys.name === systemName);
      if (system) {
        system.img = iconPath;
        localStorage.setItem('subsystems', JSON.stringify(systems));
        renderSubsystems();
        closeModal('customizeModal');
        alert('åœ–æ¨™å·²æ›´æ–°');
      }
    }

    // æ‰¹é‡æ“ä½œåŠŸèƒ½
    function showBatchOperations() {
      const modal = document.getElementById('batchModal');
      const batchList = document.getElementById('batchSystemsList');
      
      if (!modal || !batchList) return;
      
      batchList.innerHTML = '';
      const systems = getSubsystemsForIndex();
      systems.forEach(sys => {
        const item = document.createElement('div');
        item.className = 'batch-item';
        item.innerHTML = `
          <input type="checkbox" class="batch-checkbox" value="${sys.name}">
          <div class="batch-info">
            <div class="batch-name">${sys.name}</div>
            <div class="batch-desc">${sys.desc || ''}</div>
          </div>
        `;
        batchList.appendChild(item);
      });
      
      modal.classList.add('active');
    }

    function executeBatchOperation() {
      const action = document.getElementById('batchAction').value;
      const selectedSystems = Array.from(document.querySelectorAll('.batch-checkbox:checked'))
        .map(cb => cb.value);
      
      if (!action || selectedSystems.length === 0) {
        alert('è«‹é¸æ“‡æ“ä½œå’Œå­ç³»çµ±');
        return;
      }
      
      const systems = getSubsystemsForIndex();
      selectedSystems.forEach(systemName => {
        const system = systems.find(sys => sys.name === systemName);
        if (system) {
          switch (action) {
            case 'favorite':
              system.favorite = true;
              break;
            case 'unfavorite':
              system.favorite = false;
              break;
          }
        }
      });
      
      localStorage.setItem('subsystems', JSON.stringify(systems));
      renderSubsystems();
      closeModal('batchModal');
      alert(`å·²å° ${selectedSystems.length} å€‹å­ç³»çµ±åŸ·è¡Œ ${action} æ“ä½œ`);
    }

    // æœç´¢åŠŸèƒ½ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥é¡¯ç¤ºæ‰€æœ‰å­ç³»çµ±ï¼‰
    function filterBySearch(query) {
      const cards = document.querySelectorAll('.card');
      const searchQuery = query.toLowerCase().trim();
      
      cards.forEach(card => {
        const title = card.querySelector('.card-title').textContent.toLowerCase();
        const desc = card.querySelector('.card-desc').textContent.toLowerCase();
        const isMatch = title.includes(searchQuery) || desc.includes(searchQuery);
        
        if (searchQuery === '') {
          // å¦‚æœæœç´¢æ¡†ç‚ºç©ºï¼Œé¡¯ç¤ºæ‰€æœ‰å¡ç‰‡
          card.style.display = 'flex';
        } else {
          card.style.display = isMatch ? 'flex' : 'none';
        }
      });
    }
    
    // åˆ†é¡ç¯©é¸åŠŸèƒ½ - å·²ç§»é™¤ï¼ˆç›´æ¥é¡¯ç¤ºæ‰€æœ‰å­ç³»çµ±ï¼‰

    // è·³è„« HTML é¿å… XSSï¼ˆç”¨æ–¼å¡ç‰‡æ¨™é¡Œç­‰ï¼‰
    function escapeHtml(s) {
      if (s == null || s === undefined) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    
    // è·³è„« XML ç‰¹æ®Šå­—å…ƒï¼ˆç”¨æ–¼åŒ¯å‡ºï¼‰
    function escapeXml(s) {
      if (s == null || s === undefined) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }
    
    // æ¸²æŸ“å­ç³»çµ± - å„ªåŒ–ç‰ˆæœ¬ï¼ˆä½¿ç”¨ç·©å­˜å®¹å™¨ã€åœ–ç‰‡æ‡¶åŠ è¼‰ï¼‰
    function renderSubsystems() {
      const container = elements.subsystems || document.getElementById('subsystems');
      if (!container) return;
      const fragment = document.createDocumentFragment(); // ä½¿ç”¨æ–‡æª”ç‰‡æ®µæé«˜æ€§èƒ½
      
      // æ‰¹é‡è™•ç†DOMæ“ä½œ - ç›´æ¥é¡¯ç¤ºæ‰€æœ‰å¯è¦‹å­ç³»çµ±
      const visibleSystems = getSubsystemsForIndex();
      
      visibleSystems.forEach((sys, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        const safeName = escapeHtml(sys.name);
        const safeImg = escapeHtml((sys.img || '').replace(/'/g, '&#39;'));
        
        // å„ªåŒ–åœ–ç‰‡è¼‰å…¥ï¼ˆalt ä½¿ç”¨è·³è„«å¾Œåç¨±ï¼‰
        const imgElement = sys.img 
          ? `<img src='${safeImg}' class='card-img' alt='${safeName}' loading='lazy' decoding='async' onerror='this.style.display="none";this.nextElementSibling.style.display="flex"'>
             <div class='card-img' style='display:none;align-items:center;justify-content:center;font-size:2.5rem;color:#bdbdbd;'>?</div>` 
          : `<div class='card-img' style='display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:#bdbdbd;'>?</div>`;
        
        // æ¨™é¡Œè·³è„«é˜² XSSï¼›æè¿°å…è¨± HTMLï¼ˆéƒ¨åˆ†å¡ç‰‡å¦‚è¶³çƒæˆ°è¡“æ¿ä½¿ç”¨ br/spanï¼‰
        card.innerHTML = `
          ${imgElement}
          <div class="card-title">${safeName}</div>
          <div class="card-desc">${sys.desc || ''}</div>
          <button class="card-btn">æ‰“é–‹</button>
        `;
        
        // ä½¿ç”¨äº‹ä»¶å§”è¨—é¿å…éå¤šäº‹ä»¶ç›£è½å™¨
        card.dataset.url = sys.url;
        
        // è¨­ç½®å‹•ç•«å»¶é²ï¼Œç¢ºä¿æ¯å€‹å¡ç‰‡éƒ½æœ‰å‹•ç•«
        card.style.animationDelay = `${0.1 + index * 0.05}s`;
        
        fragment.appendChild(card);
      });
      
      // ä¸€æ¬¡æ€§æ›´æ–°DOM
      container.innerHTML = '';
      container.appendChild(fragment);
      // æ ¹æ“šå…§å®¹é«˜åº¦æ±ºå®šæ˜¯å¦éœ€è¦é¡¯ç¤ºæ»¾å‹•æ¢
      if (typeof updateScrollbarVisibility === 'function') {
        updateScrollbarVisibility();
      }
      
      // è§¸ç™¼é‡ç¹ªä»¥ç¢ºä¿å‹•ç•«æ­£å¸¸æ’­æ”¾
      requestAnimationFrame(() => {
        container.style.opacity = '1';
      });
    }

    // æ‡¶è¼‰å…¥åŠŸèƒ½
    function lazyLoadFeatures() {
      // åªåœ¨éœ€è¦æ™‚è¼‰å…¥é¡å¤–åŠŸèƒ½
      const features = {
        dataManager: null,
        advancedSearch: null,
        analytics: null
      };
      
      return {
        async loadDataManager() {
          if (!features.dataManager) {
            // æ¨¡æ“¬å‹•æ…‹è¼‰å…¥
            features.dataManager = await new Promise(resolve => {
              setTimeout(() => {
                resolve({
                  exportData: () => console.log('æ•¸æ“šå°å‡ºåŠŸèƒ½'),
                  importData: () => console.log('æ•¸æ“šå°å…¥åŠŸèƒ½')
                });
              }, 100);
            });
          }
          return features.dataManager;
        },
        
        async loadAdvancedSearch() {
          if (!features.advancedSearch) {
            features.advancedSearch = await new Promise(resolve => {
              setTimeout(() => {
                resolve({
                  fuzzySearch: (query) => console.log('æ¨¡ç³Šæœç´¢:', query),
                  filterByTags: (tags) => console.log('æ¨™ç±¤ç¯©é¸:', tags)
                });
              }, 100);
            });
          }
          return features.advancedSearch;
        }
      };
    }
    
    const lazyLoader = lazyLoadFeatures();

    // æ ¹æ“šå…§å®¹é«˜åº¦æ±ºå®šæ˜¯å¦é¡¯ç¤ºæ»¾å‹•æ¢
    function updateScrollbarVisibility() {
      const root = document.documentElement;
      const body = document.body;
      const contentHeight = Math.max(
        body.scrollHeight,
        root.scrollHeight,
        body.offsetHeight,
        root.offsetHeight
      );
      // åˆ¤æ–·æ˜¯å¦æº¢å‡ºï¼šå…è¨±æœ€å¤š 8px çš„æµ®å‹•ï¼ˆå­—é«”ã€å­åƒç´ æ²å‹•ã€é™°å½±ç­‰å°è‡´çš„èª¤å·®ï¼‰
      const delta = contentHeight - window.innerHeight;
      const hasOverflow = delta > 8;
      if (hasOverflow) {
        root.classList.remove('no-scroll');
        document.body.classList.remove('no-scroll');
        root.style.height = '';
        body.style.height = '';
      } else {
        root.classList.add('no-scroll');
        document.body.classList.add('no-scroll');
        // å¼·åˆ¶å°‡é é¢é«˜åº¦é–å®šç‚ºè¦–çª—é«˜åº¦ï¼Œé¿å…ç€è¦½å™¨é¡¯ç¤ºæ¥µç´°æ»¾å‹•æ¢
        const h = window.innerHeight + 'px';
        root.style.height = h;
        body.style.height = h;
      }
    }
    window.addEventListener('resize', throttle(updateScrollbarVisibility, 150));

    // æ‰“é–‹ç®¡ç†é é¢
    function openAdminPage() {
      try {
        console.log('æ‰“é–‹ç®¡ç†é é¢...');
        window.location.href = 'admin.html';
      } catch (error) {
        console.error('æ‰“é–‹ç®¡ç†é é¢å¤±æ•—:', error);
        alert('ç„¡æ³•æ‰“é–‹ç®¡ç†é é¢ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
      }
    }
    
    // æ¸…é™¤æ‰€æœ‰loadingçŠ¶æ€
    function clearAllLoadingStates() {
      // æ¸…é™¤æ‰€æœ‰å¡ç‰‡çš„loadingçŠ¶æ€
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.classList.remove('loading');
        card.style.transform = '';
        
        // æ¸…é™¤æŒ‰é’®çš„loadingçŠ¶æ€
        const btn = card.querySelector('.card-btn');
        if (btn) {
          btn.classList.remove('loading');
          // æ¢å¤æŒ‰é’®åŸå§‹æ–‡å­—
          const originalText = btn.dataset.originalText || 'æ‰“é–‹';
          btn.textContent = originalText;
        }
      });
      
      console.log('å·²æ¸…é™¤æ‰€æœ‰loadingçŠ¶æ€');
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initElements(); // ç·©å­˜å¸¸ç”¨ DOM å…ƒç´ 
      clearAllLoadingStates();
      initTheme();
      loadSubsystemsData();
      renderSubsystems();
      
      // å»¶é²é è¼‰å…¥ä»¥æå‡åˆå§‹è¼‰å…¥é€Ÿåº¦
      setTimeout(() => {
        preloadAllSubsystems();
      }, 3000);
      
      // å»¶é²å‹•ç•«å„ªåŒ–
      setTimeout(() => {
        optimizeAnimations();
      }, 5000);
      
      // æ·»åŠ äº‹ä»¶å§”è¨—è™•ç†å¡ç‰‡é»æ“Šï¼ˆä½¿ç”¨ç·©å­˜å…ƒç´ ï¼‰
      const subsEl = elements.subsystems;
      if (subsEl) subsEl.addEventListener('click', function(e) {
        const card = e.target.closest('.card');
        if (card && card.dataset.url) {
          if (e.target.classList.contains('card-btn')) {
            smoothNavigateToSubsystem(card, card.dataset.url);
          }
        }
      });
      

      
      // æ·»åŠ å³æ™‚åŒæ­¥æ©Ÿåˆ¶
      window.addEventListener('storage', function(e) {
        if (e.key === 'subsystems') {
          console.log('æª¢æ¸¬åˆ°å­ç³»çµ±æ•¸æ“šè®Šæ›´ï¼Œé‡æ–°è¼‰å…¥...');
          loadSubsystemsData();
          renderSubsystems();
          updateScrollbarVisibility();
        }
      });
      
      // æ·»åŠ æœç´¢åŠŸèƒ½ï¼ˆé˜²æŠ– 300msï¼‰- å·²éš±è—
      const searchInput = elements.searchInput;
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            filterBySearch(e.target.value);
          }, 300); // 300ms é˜²æŠ–
        });
      }
      
      // æ·»åŠ å¿«æ·éµæ”¯æ´ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
      document.addEventListener('keydown', (e) => {
        // ä¸»é¡Œåˆ‡æ›å¿«æ·éµ (Ctrl/Cmd + T)
        if ((e.ctrlKey || e.metaKey) && e.key === 't') {
          e.preventDefault();
          toggleTheme();
          console.log('å·²åˆ‡æ›ä¸»é¡Œ');
        }
      });
      
      // æ¨é€é€šçŸ¥åŠŸèƒ½ - åªåœ¨æ”¯æ´çš„ç’°å¢ƒä¸‹å•Ÿç”¨
      if ('Notification' in window) {
        requestNotificationPermission();
      }
      
      // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ¸…é™¤loadingçŠ¶æ€
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œæ¸…é™¤æ‰€æœ‰loadingçŠ¶æ€
          clearAllLoadingStates();
          updateScrollbarVisibility();
        }
      });
      
    // é¡¯ç¤ºæ§åˆ¶åŠŸèƒ½ - å·²ç°¡åŒ–ï¼ˆç›´æ¥é¡¯ç¤ºæ‰€æœ‰å­ç³»çµ±ï¼‰
    
    // æ€§èƒ½ç›£æ§
    if ('performance' in window) {
      window.addEventListener('load', () => {
        const loadTime = performance.now();
        console.log(`é é¢è¼‰å…¥æ™‚é–“: ${loadTime.toFixed(2)}ms`);
        
        // ç›£æ§è³‡æºè¼‰å…¥
        const resources = performance.getEntriesByType('resource');
        const slowResources = resources.filter(r => r.duration > 1000);
        if (slowResources.length > 0) {
          console.warn('æ…¢é€Ÿè³‡æº:', slowResources);
        }
        // é¦–æ¬¡è¼‰å…¥å¾Œæª¢æŸ¥æ»¾å‹•æ¢ï¼ˆå¤šæ¬¡å‘¼å«é¿å…å­—é«”/åœ–ç‰‡å»¶é²ï¼‰
        updateScrollbarVisibility();
        setTimeout(updateScrollbarVisibility, 150);
        setTimeout(updateScrollbarVisibility, 400);
      });
    }
      
      // æ·»åŠ å…¨å±€éŒ¯èª¤è™•ç†
      window.addEventListener('error', (e) => {
        console.error('æ‡‰ç”¨éŒ¯èª¤:', e.error);
        // å¯ä»¥ç™¼é€åˆ°éŒ¯èª¤è¿½è¹¤æœå‹™
      });
      
      window.addEventListener('unhandledrejection', (e) => {
        console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
        e.preventDefault();
      });
    });

    // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });

    // é †æš¢è·³è½‰åŠŸèƒ½ - ç´”HTMLç‰ˆæœ¬
    function smoothNavigateToSubsystem(card, url) {
      // é˜²æ­¢é‡è¤‡é»æ“Š
      if (card.classList.contains('loading')) {
        return;
      }
      
      // æ·»åŠ è¼‰å…¥ç‹€æ…‹
      card.classList.add('loading');
      const btn = card.querySelector('.card-btn');
      if (btn) {
        // ä¿å­˜åŸå§‹æ–‡å­—
        if (!btn.dataset.originalText) {
          btn.dataset.originalText = btn.textContent;
        }
        btn.classList.add('loading');
        btn.textContent = 'è¼‰å…¥ä¸­...';
      }
      
      // ä½¿ç”¨ requestAnimationFrame å„ªåŒ–å‹•ç•«æ€§èƒ½
      requestAnimationFrame(() => {
        card.style.transform = 'scale(0.95)';
      });
      
      // æ¸›å°‘å»¶é²æ™‚é–“ï¼Œæå‡éŸ¿æ‡‰é€Ÿåº¦
      setTimeout(() => {
        try {
          console.log('æ‰“é–‹å­ç³»çµ±:', url);
          
          // ç›´æ¥è·³è½‰åˆ°å­ç³»çµ±
          window.location.href = url;
        } catch (error) {
          console.error('è·³è½‰å¤±æ•—:', error);
          showNavigationFeedback(card, 'error');
        }
      }, 150);
    }
    
    // é¡¯ç¤ºè·³è½‰åé¥‹ - å„ªåŒ–ç‰ˆæœ¬
    function showNavigationFeedback(card, type) {
      // ç§»é™¤è¼‰å…¥ç‹€æ…‹
      card.classList.remove('loading');
      const btn = card.querySelector('.card-btn');
      if (btn) {
        btn.classList.remove('loading');
        // ä½¿ç”¨ä¿å­˜çš„åŸå§‹æ–‡å­—æˆ–é»˜è®¤æ–‡å­—
        const originalText = btn.dataset.originalText || 'æ‰“é–‹';
        btn.textContent = type === 'success' ? 'å·²æ‰“é–‹' : originalText;
      }
      
      // ä½¿ç”¨ requestAnimationFrame å„ªåŒ–å‹•ç•«æ€§èƒ½
      requestAnimationFrame(() => {
        if (type === 'success') {
          card.style.transform = 'scale(1.05)';
          card.style.boxShadow = '0 8px 25px rgba(34, 197, 94, 0.3)';
        } else {
          card.style.transform = 'scale(0.98)';
          card.style.boxShadow = '0 4px 15px rgba(239, 68, 68, 0.3)';
        }
        
        // ä½¿ç”¨æ›´çŸ­çš„å‹•ç•«æ™‚é–“
        setTimeout(() => {
          requestAnimationFrame(() => {
            card.style.transform = '';
            card.style.boxShadow = '';
          });
        }, 300); // æ¸›å°‘åˆ°300ms
      });
    }
    
    // é è¼‰å…¥å­ç³»çµ±é é¢
    function preloadSubsystem(url) {
      const link = document.createElement('link');
      link.rel = 'prefetch';
      link.href = url;
      document.head.appendChild(link);
    }
    
    // æ‰¹é‡é è¼‰å…¥æ‰€æœ‰å­ç³»çµ±
    function preloadAllSubsystems() {
      const subsystems = getSubsystemsForIndex(); // åªé è¼‰å…¥å¯è¦‹çš„å­ç³»çµ±
      subsystems.forEach(sys => {
        preloadSubsystem(sys.url);
      });
    }
    
    // å‹•ç•«æ€§èƒ½å„ªåŒ–
    function optimizeAnimations() {
      // ä½¿ç”¨ Intersection Observer å„ªåŒ–å‹•ç•«æ€§èƒ½
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.style.willChange = 'transform, opacity, box-shadow';
            } else {
              entry.target.style.willChange = 'auto';
            }
          });
        }, {
          threshold: 0.1
        });
        
        // è§€å¯Ÿæ‰€æœ‰å¡ç‰‡
        document.querySelectorAll('.card').forEach(card => {
          observer.observe(card);
        });
      }
    }
    
    // åˆ†é¡ç¯©é¸åŠŸèƒ½
    function getSubsystemsForIndex() {
      const savedData = localStorage.getItem('subsystems');
      if (savedData) {
        try {
          const parsed = JSON.parse(savedData);
          if (Array.isArray(parsed)) {
            // åªè¿”å›å¯è¦‹çš„å­ç³»çµ±
            return parsed.filter(sys => sys.visible !== false);
          }
        } catch (e) {}
      }
      // æ²’æœ‰å°±ç”¨é è¨­ï¼Œä¹Ÿè¦éæ¿¾éš±è—çš„
      return defaultSubsystems.filter(sys => sys.visible !== false);
    }
  </script>
  <script>
  window.addEventListener('storage', function(e) {
    if (e.key === 'subsystems') {
      // é‡æ–°è¼‰å…¥å­ç³»çµ±æ•¸æ“šä¸¦é‡æ–°æ¸²æŸ“ï¼Œè€Œä¸æ˜¯æ•´å€‹é é¢é‡è¼‰
      loadSubsystemsData();
      renderSubsystems();
      console.log('å­ç³»çµ±æ•¸æ“šå·²æ›´æ–°ï¼Œé‡æ–°æ¸²æŸ“å®Œæˆ');
    }
  });
  </script>
</body>
</html> 
