<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="éš¨æ©Ÿå¡">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <title>éš¨æ©Ÿå¡</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <a href="../index.html" class="back-btn">â† è¿”å›ä¸»ç³»çµ±</a>
    <a href="admin.html" class="admin-btn">ç®¡ç†è€…ç™»å…¥</a>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ´ éš¨æ©Ÿå¡</h1>
            <div class="date-display" id="date-display">è¼‰å…¥ä¸­...</div>
        </div>

        <!-- å¡ç‰‡å®¹å™¨ -->
        <div class="cards-wrapper" id="cards-wrapper">
            <!-- ä¸Šä¸€é æŒ‰éˆ• -->
            <button class="page-nav-btn page-nav-prev" id="prev-btn" onclick="switchPage(-1)" style="display: none;">
                <span>â€¹</span>
            </button>
            
            <!-- å¡ç‰‡å®¹å™¨ -->
            <div class="cards-container" id="cards-container">
            <div class="card" id="card-0">
                <!-- å¡ç‰‡èƒŒé¢ -->
                <div class="card-face card-back">
                    <div class="card-back-content">
                        <div class="card-back-icon">ğŸ´</div>
                        <div class="card-back-text">ç­‰å¾…æŠ½å¡</div>
                    </div>
                </div>
                <!-- å¡ç‰‡æ­£é¢ -->
                <div class="card-face card-front">
                    <div class="card-front-content">
                        <div class="card-category">é¼“å‹µ</div>
                        <div class="card-icon">âœ¨</div>
                        <div class="card-text">æº–å‚™å¥½æŠ½å¡äº†å—ï¼Ÿ</div>
                    </div>
                </div>
            </div>
            <div class="card" id="card-1">
                <!-- å¡ç‰‡èƒŒé¢ -->
                <div class="card-face card-back">
                    <div class="card-back-content">
                        <div class="card-back-icon">ğŸ´</div>
                        <div class="card-back-text">ç­‰å¾…æŠ½å¡</div>
                    </div>
                </div>
                <!-- å¡ç‰‡æ­£é¢ -->
                <div class="card-face card-front">
                    <div class="card-front-content">
                        <div class="card-category">é¼“å‹µ</div>
                        <div class="card-icon">âœ¨</div>
                        <div class="card-text">æº–å‚™å¥½æŠ½å¡äº†å—ï¼Ÿ</div>
                    </div>
                </div>
            </div>
            <div class="card" id="card-2">
                <!-- å¡ç‰‡èƒŒé¢ -->
                <div class="card-face card-back">
                    <div class="card-back-content">
                        <div class="card-back-icon">ğŸ´</div>
                        <div class="card-back-text">ç­‰å¾…æŠ½å¡</div>
                    </div>
                </div>
                <!-- å¡ç‰‡æ­£é¢ -->
                <div class="card-face card-front">
                    <div class="card-front-content">
                        <div class="card-category">é¼“å‹µ</div>
                        <div class="card-icon">âœ¨</div>
                        <div class="card-text">æº–å‚™å¥½æŠ½å¡äº†å—ï¼Ÿ</div>
                    </div>
                </div>
            </div>
            <!-- ç¬¬äºŒè¡Œå¡ç‰‡ï¼ˆç”¨æ–¼é¡¯ç¤ºç¬¬äºŒæ¬¡æŠ½å¡ï¼‰ -->
            <div class="card" id="card-3" style="display: none;">
                <!-- å¡ç‰‡èƒŒé¢ -->
                <div class="card-face card-back">
                    <div class="card-back-content">
                        <div class="card-back-icon">ğŸ´</div>
                        <div class="card-back-text">ç­‰å¾…æŠ½å¡</div>
                    </div>
                </div>
                <!-- å¡ç‰‡æ­£é¢ -->
                <div class="card-face card-front">
                    <div class="card-front-content">
                        <div class="card-category">é¼“å‹µ</div>
                        <div class="card-icon">âœ¨</div>
                        <div class="card-text">æº–å‚™å¥½æŠ½å¡äº†å—ï¼Ÿ</div>
                    </div>
                </div>
            </div>
            <div class="card" id="card-4" style="display: none;">
                <!-- å¡ç‰‡èƒŒé¢ -->
                <div class="card-face card-back">
                    <div class="card-back-content">
                        <div class="card-back-icon">ğŸ´</div>
                        <div class="card-back-text">ç­‰å¾…æŠ½å¡</div>
                    </div>
                </div>
                <!-- å¡ç‰‡æ­£é¢ -->
                <div class="card-face card-front">
                    <div class="card-front-content">
                        <div class="card-category">é¼“å‹µ</div>
                        <div class="card-icon">âœ¨</div>
                        <div class="card-text">æº–å‚™å¥½æŠ½å¡äº†å—ï¼Ÿ</div>
                    </div>
                </div>
            </div>
            <div class="card" id="card-5" style="display: none;">
                <!-- å¡ç‰‡èƒŒé¢ -->
                <div class="card-face card-back">
                    <div class="card-back-content">
                        <div class="card-back-icon">ğŸ´</div>
                        <div class="card-back-text">ç­‰å¾…æŠ½å¡</div>
                    </div>
                </div>
                <!-- å¡ç‰‡æ­£é¢ -->
                <div class="card-face card-front">
                    <div class="card-front-content">
                        <div class="card-category">é¼“å‹µ</div>
                        <div class="card-icon">âœ¨</div>
                        <div class="card-text">æº–å‚™å¥½æŠ½å¡äº†å—ï¼Ÿ</div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸‹ä¸€é æŒ‰éˆ• -->
            <button class="page-nav-btn page-nav-next" id="next-btn" onclick="switchPage(1)" style="display: none;">
                <span>â€º</span>
            </button>
        </div>
        
        <!-- é é¢æŒ‡ç¤ºå™¨ -->
        <div class="page-indicator" id="page-indicator" style="display: none;">
            <span class="page-dot active" data-page="0"></span>
            <span class="page-dot" data-page="1"></span>
        </div>

        <!-- ç‹€æ…‹è¨Šæ¯ -->
        <div class="status-message" id="status-message">
            é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŠ½ä¸‰å¼µå‹µå¿—å¡ç‰‡
        </div>

        <!-- æŠ½å¡æŒ‰éˆ• -->
        <button class="btn" id="draw-btn" onclick="drawCard()">
            æŠ½ä¸‰å¼µå¡ç‰‡
        </button>

    </div>

    <!-- è¨­å®šé¢æ¿ -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>âš™ï¸ è¨­å®š</h2>
                <button class="close-btn" onclick="toggleSettings()">Ã—</button>
            </div>
            
            <div class="settings-body">
                <p style="text-align: center; color: var(--text-secondary); padding: 2rem 1rem;">
                    è¨­å®šé¸é …å·²ç§»è‡³é¦–é é ‚éƒ¨
                </p>
            </div>
        </div>
    </div>

    <script>
        // iOS Safari è¦–å£é«˜åº¦ä¿®å¾©
        (function() {
            // è¨­ç½®è¦–å£é«˜åº¦è®Šé‡ï¼Œè§£æ±ºiOS Safariçš„100vhå•é¡Œ
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            // åˆå§‹è¨­ç½®
            setViewportHeight();
            
            // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼ˆåŒ…æ‹¬iOS Safariåœ°å€æ¬„éš±è—/é¡¯ç¤ºå’ŒAndroidç€è¦½å™¨ï¼‰
            if (typeof window !== 'undefined') {
                window.addEventListener('resize', setViewportHeight);
                window.addEventListener('orientationchange', function() {
                    // å»¶é²ä¸€ä¸‹è®“iOSå’ŒAndroidå®Œæˆæ—‹è½‰
                    setTimeout(setViewportHeight, 100);
                });
                // ç›£è½è¦–çª—ç„¦é»è®ŠåŒ–ï¼ˆè™•ç†Androidç€è¦½å™¨åœ°å€æ¬„ï¼‰
                window.addEventListener('focus', function() {
                    setTimeout(setViewportHeight, 100);
                });
                // ç›£è½è¦–è¦ºè¦–å£è®ŠåŒ–ï¼ˆæ›´æº–ç¢ºçš„ç§»å‹•ç«¯è¦–å£æª¢æ¸¬ï¼‰
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', setViewportHeight);
                }
            }
            
            // é˜²æ­¢iOS Safariå’ŒAndroidçš„é›™æ“Šç¸®æ”¾ï¼ˆåƒ…åœ¨æŒ‰éˆ•å’Œé€£çµä¸Šï¼‰
            let lastTouchEnd = 0;
            if (typeof document !== 'undefined') {
                document.addEventListener('touchend', function(event) {
                    const target = event.target;
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæŒ‰éˆ•æˆ–é€£çµ
                    var isButtonOrLink = target.tagName === 'BUTTON' || target.tagName === 'A';
                    if (!isButtonOrLink && target.closest) {
                        isButtonOrLink = target.closest('button') || target.closest('a');
                    }
                    if (isButtonOrLink) {
                        const now = Date.now();
                        if (now - lastTouchEnd <= 300) {
                            event.preventDefault();
                        }
                        lastTouchEnd = now;
                    }
                }, { passive: false });
            }
            
            // é˜²æ­¢iOS Safariå’ŒAndroidä¸‹æ‹‰åˆ·æ–°ï¼ˆåœ¨æŸäº›æƒ…æ³ä¸‹ï¼‰
            let touchStartY = 0;
            if (typeof document !== 'undefined') {
                document.addEventListener('touchstart', function(event) {
                    if (event.touches && event.touches.length > 0) {
                        touchStartY = event.touches[0].clientY;
                    }
                }, { passive: true });
                
                document.addEventListener('touchmove', function(event) {
                    // å¦‚æœå‘ä¸‹æ»‘å‹•ä¸”å·²ç¶“åœ¨é ‚éƒ¨ï¼Œé˜»æ­¢ä¸‹æ‹‰åˆ·æ–°
                    if (event.touches && event.touches.length > 0) {
                        const touchY = event.touches[0].clientY;
                        if (touchY > touchStartY && (typeof window !== 'undefined' && window.scrollY === 0)) {
                            event.preventDefault();
                        }
                    }
                }, { passive: false });
            }
        })();
        
        // ç«‹å³æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®ï¼ˆåœ¨ä»»ä½•è„šæœ¬åŠ è½½å‰ï¼‰
        (function() {
            // æ£€æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰å®Œæ•´æ•°æ®
            try {
                const savedCards = localStorage.getItem('cardsData');
                if (savedCards) {
                    const parsed = JSON.parse(savedCards);
                    if (parsed.length >= 400) {
                        console.log('âœ… æ£€æµ‹åˆ° localStorage ä¸­æœ‰å®Œæ•´æ•°æ®ï¼ˆ' + parsed.length + 'æ¡ï¼‰');
                        return; // å·²æœ‰å®Œæ•´æ•°æ®ï¼Œä¸éœ€è¦åˆå§‹åŒ–
                    }
                }
            } catch (e) {
                console.warn('æ£€æŸ¥ localStorage å¤±è´¥:', e);
            }
            
            // å¦‚æœæ²¡æœ‰å®Œæ•´æ•°æ®ï¼Œå°è¯•ç«‹å³åˆå§‹åŒ–
            console.log('ğŸ”„ å‡†å¤‡åˆå§‹åŒ–æ•°æ®...');
        })();
    </script>
    <script src="js/card-system.js"></script>
    <script src="js/settings.js"></script>
    <script>
        // ç¡®ä¿æ•°æ®åˆå§‹åŒ–ï¼šåœ¨é¡µé¢åŠ è½½åæ£€æŸ¥å¹¶åˆå§‹åŒ–å®Œæ•´æ•°æ®
        window.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç­‰å¾… card-system.js åŠ è½½å®Œæˆ
            setTimeout(function() {
                checkAndInitializeData();
            }, 1000); // å¢åŠ å»¶è¿Ÿç¡®ä¿ cardSystem å®Œå…¨åˆå§‹åŒ–
        });

        async function checkAndInitializeData() {
            // æ£€æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰å®Œæ•´çš„400æ¡æ•°æ®
            const savedCards = localStorage.getItem('cardsData');
            let needsInit = false;
            
            if (!savedCards) {
                needsInit = true;
                console.log('ğŸ“­ localStorage ä¸­æ²¡æœ‰æ•°æ®ï¼Œéœ€è¦åˆå§‹åŒ–');
            } else {
                try {
                    const parsedCards = JSON.parse(savedCards);
                    if (parsedCards.length < 400) {
                        needsInit = true;
                        console.log('âš ï¸ localStorage ä¸­çš„æ•°æ®ä¸å®Œæ•´ï¼ˆ' + parsedCards.length + 'æ¡ï¼‰ï¼Œéœ€è¦é‡æ–°åŠ è½½');
                    } else {
                        console.log('âœ… localStorage ä¸­å·²æœ‰å®Œæ•´æ•°æ®ï¼ˆ' + parsedCards.length + 'æ¡ï¼‰');
                    }
                } catch (e) {
                    needsInit = true;
                    console.error('âŒ è§£æ localStorage æ•°æ®å¤±è´¥:', e);
                }
            }

            // å¦‚æœéœ€è¦åˆå§‹åŒ–ï¼Œå°è¯•ä» cards.json æ–‡ä»¶åŠ è½½
            if (needsInit) {
                console.log('ğŸ”„ æ­£åœ¨ä»æ–‡ä»¶åŠ è½½å®Œæ•´æ•°æ®...');
                let loaded = false;
                
                // æ–¹æ³•1: å°è¯•ä» cards.json æ–‡ä»¶åŠ è½½
                try {
                    const response = await fetch('./data/cards.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.length >= 400) {
                            localStorage.setItem('cardsData', JSON.stringify(data));
                            console.log('âœ… æˆåŠŸä»æ–‡ä»¶åŠ è½½å¹¶ä¿å­˜å®Œæ•´æ•°æ®ï¼ˆ' + data.length + 'æ¡ï¼‰');
                            loaded = true;
                        } else {
                            console.warn('âš ï¸ æ–‡ä»¶ä¸­çš„æ•°æ®ä¸å®Œæ•´ï¼ˆ' + data.length + 'æ¡ï¼‰');
                        }
                    }
                } catch (error) {
                    console.error('âŒ ä»æ–‡ä»¶åŠ è½½å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ CORS é—®é¢˜ï¼‰:', error);
                }
                
                // æ–¹æ³•2: å¦‚æœæ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œå°è¯•ä» admin.html æå–æ•°æ®
                if (!loaded) {
                    console.log('ğŸ”„ å°è¯•ä» admin.html æå–å®Œæ•´æ•°æ®...');
                    try {
                        const adminResponse = await fetch('./admin.html');
                        if (adminResponse.ok) {
                            const adminHtml = await adminResponse.text();
                            // æå– defaultCardsData
                            const match = adminHtml.match(/const defaultCardsData\s*=\s*(\[[\s\S]*?\])\s*;/);
                            if (match && match[1]) {
                                try {
                                    const fullData = JSON.parse(match[1]);
                                    if (fullData && Array.isArray(fullData) && fullData.length >= 400) {
                                        localStorage.setItem('cardsData', JSON.stringify(fullData));
                                        console.log('âœ… æˆåŠŸä» admin.html æå–å¹¶ä¿å­˜å®Œæ•´æ•°æ®ï¼ˆ' + fullData.length + 'æ¡ï¼‰');
                                        loaded = true;
                                    }
                                } catch (parseError) {
                                    console.error('è§£æä» admin.html æå–çš„ JSON å¤±è´¥:', parseError);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('ä» admin.html è·å–æ•°æ®å¤±è´¥:', error);
                    }
                }
                
                // å¦‚æœæˆåŠŸåŠ è½½ï¼Œæ›´æ–°å¡ç‰‡ç³»ç»Ÿ
                if (loaded && window.cardSystem) {
                    await window.cardSystem.forceLoadCompleteData();
                    // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
                    const statusMsg = document.getElementById('status-message');
                    if (statusMsg) {
                        statusMsg.textContent = 'é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŠ½ä¸‰å¼µå‹µå¿—å¡ç‰‡';
                        statusMsg.style.color = '';
                    }
                } else if (!loaded) {
                    // å¦‚æœä¸¤ç§æ–¹æ³•éƒ½å¤±è´¥
                    console.error('âŒ æ— æ³•åŠ è½½å®Œæ•´æ•°æ®ï¼');
                    const statusMsg = document.getElementById('status-message');
                    if (statusMsg) {
                        statusMsg.textContent = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’"ç®¡ç†è€…ç™»å…¥"åˆå§‹åŒ–æ•°æ®';
                        statusMsg.style.color = '#FF6B6B';
                    }
                }
            }
        }
    </script>
</body>
</html>



