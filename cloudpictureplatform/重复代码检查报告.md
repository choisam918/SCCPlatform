# 重复代码检查报告

## 检查时间
2024年检查

## 发现的重复代码模式

### 1. **图片查看器打开逻辑重复** ⚠️ 高优先级

**位置：**
- `js/gallery.js:255-274` - `showImageModal` 函数
- `js/3d-gallery.js:933-963` - `photoGroup.userData.onClick` 回调

**重复代码：**
```javascript
// 两个地方都有相同的逻辑
const imageUrl = URL.createObjectURL(photo.file);
if (window.mobileFixes && typeof window.mobileFixes.fix3DImageZoom === 'function') {
    const tempImg = document.createElement('img');
    tempImg.src = imageUrl;
    tempImg.style.display = 'none';
    document.body.appendChild(tempImg);
    setTimeout(() => {
        tempImg.click();
        setTimeout(() => document.body.removeChild(tempImg), 100/200);
    }, 100);
} else {
    window.open(imageUrl, '_blank');
}
```

**建议：** 提取为公共函数 `openImageViewer(photo)` 在 `utils.js` 中

---

### 2. **按钮事件处理模式重复** ⚠️ 中优先级

**位置：**
- `js/3d-gallery.js:1220-1260` - 左旋转按钮
- `js/3d-gallery.js:1265-1305` - 右旋转按钮
- `js/3d-gallery.js:1309-1350` - 缩放+按钮
- `js/3d-gallery.js:1355-1396` - 缩放-按钮

**重复代码模式：**
```javascript
// 4个按钮都有相同的模式
const newBtn = btn.cloneNode(true);
btn.parentNode.replaceChild(newBtn, btn);
newBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    // 尝试多种方式调用函数
    if (typeof window.functionName === 'function') {
        window.functionName(...);
    } else if (typeof functionName === 'function') {
        functionName(...);
    } else {
        // 备用方案
    }
});
```

**建议：** 提取为公共函数 `setupButtonWithFallback(buttonId, handler, fallbackHandler)`

---

### 3. **相机位置计算逻辑重复** ⚠️ 中优先级

**位置：**
- `js/3d-gallery.js:1243-1256` - 左旋转按钮备用方案
- `js/3d-gallery.js:1289-1300` - 右旋转按钮备用方案
- `js/3d-gallery.js:1326-1346` - 缩放+按钮备用方案
- `js/3d-gallery.js:1370-1390` - 缩放-按钮备用方案

**重复代码：**
```javascript
// 相机位置计算的重复逻辑
const currentPos = camera.position.clone();
const target = controls.target ? controls.target.clone() : new THREE.Vector3(0, 0, 0);
const dx = currentPos.x - target.x;
const dz = currentPos.z - target.z;
const distance = Math.sqrt(dx * dx + dz * dz);
const currentAngle = Math.atan2(dz, dx);
const newAngle = currentAngle + radians;
const newX = target.x + distance * Math.cos(newAngle);
const newZ = target.z + distance * Math.sin(newAngle);
camera.position.set(newX, currentPos.y, newZ);
camera.lookAt(target);
camera.updateMatrixWorld();
```

**建议：** 提取为公共函数 `rotateCameraAroundTarget(camera, target, radians)`

---

### 4. **URL.createObjectURL 使用模式** ⚠️ 低优先级

**位置：**
- `js/3d-gallery.js:934` - 图片查看器
- `js/3d-gallery.js:989` - 纹理加载
- `js/gallery.js:257` - 图片查看器
- `js/image-processor.js:165` - 图片处理

**重复模式：**
- 多处创建 ObjectURL
- 部分地方有释放逻辑，部分没有
- 释放时机不一致

**建议：** 统一管理 ObjectURL 的创建和释放，或使用工具函数

---

### 5. **错误处理模式重复** ⚠️ 低优先级

**位置：**
- 多个文件中的 try-catch 块
- `js/3d-gallery.js` 中多处错误处理
- `js/upload.js` 中多处错误处理

**重复模式：**
```javascript
try {
    // 操作
} catch (error) {
    console.error('错误信息:', error);
    // 降级方案或通知
}
```

**建议：** 统一错误处理函数（已有 `showNotification`，可扩展）

---

### 6. **元素获取模式** ⚠️ 低优先级

**位置：**
- `js/upload.js` 中多次 `document.getElementById`
- `js/gallery.js` 中多次 `document.getElementById`
- `js/3d-gallery.js` 中多次 `document.getElementById`

**重复模式：**
```javascript
const element = document.getElementById('elementId');
// 使用元素
```

**建议：** 可以使用缓存或工具函数（但影响较小）

---

### 7. **相机/场景/渲染器检查** ⚠️ 低优先级

**位置：**
- `js/3d-gallery.js` 中多处检查：
  - `if (!scene || !camera || !renderer)`
  - `if (!renderer || !camera)`
  - `if (!camera)`

**重复模式：**
```javascript
if (!scene || !camera || !renderer) {
    console.warn('...');
    return;
}
```

**建议：** 提取为工具函数 `checkSceneComponents(scene, camera, renderer)`

---

### 8. **按钮克隆和替换模式** ⚠️ 低优先级

**位置：**
- `js/3d-gallery.js:1220-1221` - 左旋转按钮
- `js/3d-gallery.js:1266-1267` - 右旋转按钮
- `js/3d-gallery.js:1310-1311` - 缩放+按钮
- `js/3d-gallery.js:1356-1357` - 缩放-按钮

**重复代码：**
```javascript
const newBtn = btn.cloneNode(true);
btn.parentNode.replaceChild(newBtn, btn);
```

**建议：** 提取为工具函数 `replaceButton(buttonId)`

---

## 重复代码统计

| 类型 | 重复次数 | 优先级 | 影响范围 |
|------|---------|--------|----------|
| 图片查看器逻辑 | 2处 | 高 | gallery.js, 3d-gallery.js |
| 按钮事件处理 | 4处 | 中 | 3d-gallery.js |
| 相机位置计算 | 4处 | 中 | 3d-gallery.js |
| ObjectURL管理 | 4处 | 低 | 多个文件 |
| 错误处理模式 | 多处 | 低 | 所有文件 |
| 元素获取 | 多处 | 低 | 所有文件 |
| 场景组件检查 | 多处 | 低 | 3d-gallery.js |
| 按钮克隆替换 | 4处 | 低 | 3d-gallery.js |

---

## 优化建议优先级

### 高优先级（立即优化）
1. **提取图片查看器逻辑** - 减少重复代码，统一行为
   - 创建 `openImageViewer(photo)` 函数
   - 统一 ObjectURL 的创建和释放

### 中优先级（建议优化）
2. **提取按钮事件处理模式** - 减少代码重复
   - 创建 `setupButtonWithFallback()` 函数
3. **提取相机位置计算** - 减少重复逻辑
   - 创建 `rotateCameraAroundTarget()` 函数

### 低优先级（可选优化）
4. **统一错误处理** - 提高代码一致性
5. **场景组件检查工具函数** - 提高代码可读性
6. **按钮克隆替换工具函数** - 简化代码

---

## 注意事项

⚠️ **用户要求：不要删除任何代码**

所有优化建议都是**提取为公共函数**，而不是删除重复代码。重复代码可以保留作为备用或降级方案。

---

## 建议的优化步骤

1. 在 `utils.js` 中添加公共函数
2. 在需要的地方调用公共函数
3. **保留原有代码作为注释或备用方案**（符合用户要求）

---

## 总结

发现的主要重复代码：
- **图片查看器逻辑**：2处完全重复
- **按钮事件处理**：4处高度相似
- **相机计算逻辑**：4处高度相似
- **其他模式**：多处轻微重复

**总体评估：** 代码质量良好，主要重复集中在按钮处理和图片查看器逻辑，建议优先优化这两处。

