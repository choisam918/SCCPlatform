# 上传照片数量限制说明

## 一、限制规则

### 1.1 核心限制
- **最多上传照片数量**：20张
- **单次选择限制**：一次最多选择20张照片
- **总存储限制**：系统最多存储20张照片

### 1.2 限制原因
- **性能考虑**：3D展览馆需要渲染所有照片，限制数量可保证流畅性能
- **存储空间**：浏览器本地存储空间有限
- **用户体验**：适中的数量可提供更好的浏览体验

---

## 二、限制实现

### 2.1 选择阶段限制

#### 文件选择器限制
```javascript
// 文件选择时检查数量
function handleFileSelect(files) {
    const maxPhotos = 20;
    const currentCount = getCurrentPhotoCount();
    const newFiles = Array.from(files);
    
    // 检查总数是否超过限制
    if (currentCount + newFiles.length > maxPhotos) {
        const allowedCount = maxPhotos - currentCount;
        showError(`最多只能上传${maxPhotos}张照片，当前已有${currentCount}张，还可以上传${allowedCount}张`);
        
        // 只保留允许的数量
        return newFiles.slice(0, allowedCount);
    }
    
    return newFiles;
}
```

#### 界面提示
- **数量显示**：显示"已选择 X/20 张照片"
- **达到限制**：当达到20张时，禁用文件选择器或显示提示
- **超出限制**：如果用户尝试选择超过限制的数量，显示错误提示

### 2.2 上传阶段限制

#### 上传前检查
```javascript
function validateBeforeUpload() {
    const existingPhotos = getStoredPhotos();
    const newPhotos = getSelectedPhotos();
    const maxPhotos = 20;
    
    // 检查总数
    if (existingPhotos.length + newPhotos.length > maxPhotos) {
        const needDelete = (existingPhotos.length + newPhotos.length) - maxPhotos;
        
        return {
            valid: false,
            message: `上传后照片总数将超过${maxPhotos}张，需要删除${needDelete}张旧照片，或减少${needDelete}张新照片`,
            needDelete: needDelete
        };
    }
    
    return { valid: true };
}
```

#### 处理策略
1. **提示用户**：显示当前照片数和限制
2. **提供选项**：
   - 删除旧照片后再上传
   - 减少新照片数量
   - 取消上传

### 2.3 存储阶段限制

#### 存储检查
```javascript
async function savePhotos(photos) {
    const existingPhotos = await getStoredPhotos();
    const maxPhotos = 20;
    
    // 如果超过限制，删除最旧的照片
    if (existingPhotos.length + photos.length > maxPhotos) {
        const toDelete = (existingPhotos.length + photos.length) - maxPhotos;
        await deleteOldestPhotos(toDelete);
    }
    
    // 保存新照片
    await saveNewPhotos(photos);
}
```

---

## 三、用户界面设计

### 3.1 上传页面提示

#### 数量显示区域
```
┌─────────────────────────────────────┐
│  照片数量: 5/20                      │
│  ████████░░░░░░░░░░ 25%              │
└─────────────────────────────────────┘
```

#### 达到限制时的提示
```
┌─────────────────────────────────────┐
│  ⚠️ 已达到最大上传数量（20张）         │
│  如需上传新照片，请先删除旧照片        │
└─────────────────────────────────────┘
```

#### 超出限制时的错误提示
```
┌─────────────────────────────────────┐
│  ❌ 错误：最多只能上传20张照片         │
│  当前已选择：25张                     │
│  请减少5张照片                        │
└─────────────────────────────────────┘
```

### 3.2 展览页面提示

#### 照片总数显示
```
┌─────────────────────────────────────┐
│  当前展览：15/20 张照片               │
│  还可以上传：5张                     │
└─────────────────────────────────────┘
```

---

## 四、实现细节

### 4.1 文件选择器配置

```html
<!-- HTML -->
<input 
    type="file" 
    accept="image/*" 
    multiple 
    id="photoInput"
    onchange="handleFileSelect(event)"
/>
```

```javascript
// JavaScript - 限制选择数量
document.getElementById('photoInput').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const maxPhotos = 20;
    const currentCount = getCurrentPhotoCount();
    
    if (files.length + currentCount > maxPhotos) {
        const allowed = maxPhotos - currentCount;
        alert(`最多只能选择${maxPhotos}张照片，当前已有${currentCount}张，还可以选择${allowed}张`);
        
        // 重置文件选择器
        e.target.value = '';
        return;
    }
    
    // 处理选择的文件
    processSelectedFiles(files);
});
```

### 4.2 预览区域更新

```javascript
function updatePreviewArea(photos) {
    const count = photos.length;
    const maxPhotos = 20;
    
    // 更新数量显示
    document.getElementById('photoCount').textContent = `${count}/${maxPhotos}`;
    
    // 更新进度条
    const progress = (count / maxPhotos) * 100;
    document.getElementById('countProgress').style.width = `${progress}%`;
    
    // 如果达到限制，禁用选择按钮
    if (count >= maxPhotos) {
        document.getElementById('selectButton').disabled = true;
        document.getElementById('selectButton').textContent = '已达到最大数量';
    }
}
```

### 4.3 上传验证

```javascript
async function uploadPhotos() {
    const existingPhotos = await getStoredPhotos();
    const newPhotos = getSelectedPhotos();
    const maxPhotos = 20;
    
    // 验证总数
    if (existingPhotos.length + newPhotos.length > maxPhotos) {
        const needDelete = (existingPhotos.length + newPhotos.length) - maxPhotos;
        
        const confirm = await showConfirmDialog({
            title: '照片数量超限',
            message: `上传后照片总数将超过${maxPhotos}张，需要删除${needDelete}张旧照片。是否继续？`,
            options: ['删除旧照片并上传', '取消']
        });
        
        if (confirm === '删除旧照片并上传') {
            await deleteOldestPhotos(needDelete);
        } else {
            return; // 取消上传
        }
    }
    
    // 执行上传
    await performUpload(newPhotos);
}
```

---

## 五、用户体验优化

### 5.1 友好的提示信息

#### 提示文案
- **选择时**："已选择 X/20 张照片"
- **达到限制**："已达到最大上传数量（20张）"
- **超出限制**："最多只能上传20张照片，请减少 X 张"
- **上传时**："当前已有 X 张照片，还可以上传 Y 张"

### 5.2 交互优化

#### 达到限制时的行为
- **禁用选择按钮**：当达到20张时，禁用文件选择器
- **显示提示**：显示友好的提示信息
- **提供删除选项**：在预览区域提供删除按钮

#### 超出限制时的行为
- **自动裁剪**：自动只保留前20张（可选，不推荐）
- **提示用户**：显示错误提示，要求用户手动减少
- **重置选择**：清空文件选择器，让用户重新选择

---

## 六、数据存储

### 6.1 存储结构（IndexedDB）

```javascript
// IndexedDB 存储结构
数据库: CloudPicturePlatform

对象存储1: photos
  - 存储照片文件（Blob数据），最多20个

对象存储2: metadata
  - 存储照片元数据（JSON对象），最多20个

对象存储3: settings
  - key: "system"
  - value: {
        maxPhotos: 20,  // 系统限制
        currentCount: 15  // 当前照片数
    }
```

### 6.2 存储检查（IndexedDB）

```javascript
// 保存前检查
async function savePhoto(photoFile, thumbnail, metadata) {
    // 从IndexedDB读取当前照片数量
    const photos = await getAllPhotos();
    const maxPhotos = 20;
    
    if (photos.length >= maxPhotos) {
        throw new Error(`已达到最大照片数量限制（${maxPhotos}张）`);
    }
    
    // 保存到IndexedDB
    await savePhotoToIndexedDB(photoFile, thumbnail, metadata);
    
    // 更新照片计数
    await updatePhotoCount();
}
```

---

## 七、错误处理

### 7.1 错误类型

1. **选择时超出限制**
   - 提示：最多只能选择20张照片
   - 处理：要求用户减少选择

2. **上传时超出限制**
   - 提示：照片总数将超过20张
   - 处理：提供删除旧照片选项

3. **存储时超出限制**
   - 提示：存储失败，照片数量超限
   - 处理：自动删除最旧的照片（可选）

### 7.2 错误提示设计

```javascript
function showLimitError(type, current, max) {
    const messages = {
        select: `最多只能选择${max}张照片，当前已选择${current}张`,
        upload: `照片总数将超过${max}张，当前已有${current}张，请删除部分照片`,
        storage: `存储失败：已达到最大照片数量（${max}张）`
    };
    
    showNotification({
        type: 'error',
        message: messages[type],
        duration: 5000
    });
}
```

---

## 八、总结

### 8.1 限制要点
- **数量限制**：最多20张照片
- **验证时机**：选择时、上传前、存储时
- **用户提示**：清晰的提示信息和友好的错误处理
- **自动处理**：超出限制时提供删除选项

### 8.2 实现重点
1. **前端验证**：在选择和上传前进行验证
2. **用户提示**：清晰的提示和错误信息
3. **交互优化**：达到限制时的界面反馈
4. **数据管理**：存储时的数量检查和管理

通过合理的限制和友好的提示，可以确保系统性能，同时提供良好的用户体验。
